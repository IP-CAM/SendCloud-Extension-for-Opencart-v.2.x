<modification>
	<id>SendCloud OpenCart 2 Extension</id>
	<version>1.1.2</version>
	<vqmver>2.3.0</vqmver>
	<author>Comercia</author>

	<file name="admin/controller/extension/extension/module.php">
		<operation error="skip">
			<search position="before"><![CDATA[$data['extensions'][] = array(]]></search>
			<add position="before"><![CDATA[
            if ($extension == 'sendcloud') {
                $data['extensions'][] = array(
                'name'      => $this->language->get('heading_title'),
                'module'    => $module_data,
                'install'   => $this->url->link('extension/extension/module/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, true),
                'uninstall' => $this->url->link('extension/extension/module/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, true),
                'installed' => in_array($extension, $extensions),
                'edit'      => $this->url->link('module/' . $extension, 'token=' . $this->session->data['token'], true)
                );
                continue;
            }
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[function index(]]></search>
			<add><![CDATA[
                comercia\util::load()->controller("common/sendcloud/checkout");
            ]]>
			</add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/confirm.php">
		<operation error="skip">
			<search position="after"><![CDATA[$this->session->data['order_id'] = $this->model_checkout_order->addOrder($order_data);]]></search>
			<add><![CDATA[
			$spId = \comercia\Util::session()->spId;
			$orderId = \comercia\Util::session()->order_id;
            if (! empty($spId)) {
				$this->db->query("UPDATE " . DB_PREFIX . "order SET sendcloud_sp_id = '" . $spId . "', shipping_zone = '', shipping_zone_id=0 WHERE order_id = '" . $orderId . "'");
			}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[$this->session->data['order_id'] = $this->model_checkout_order->addOrder($data);]]></search>
			<add><![CDATA[
			$spId = \comercia\Util::session()->spId;
			$orderId = \comercia\Util::session()->order_id;
            if (! empty($spId)) {
				$this->db->query("UPDATE " . DB_PREFIX . "order SET sendcloud_sp_id = '" . $spId . "', shipping_zone = '', shipping_zone_id=0 WHERE order_id = '" .$orderId . "'");
			}
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/checkout/success.php">
		<operation error="skip">
			<search position="before"><![CDATA[unset($this->session->data['shipping_method']);]]></search>
			<add><![CDATA[
			unset($this->session->data['spId']);
			]]></add>
		</operation>
	</file>

	<file name="admin/view/template/sale/order_list.tpl">
		<operation error="abort">
			<search position="before" index="1"><![CDATA[<button type="submit" id="button-shipping"]]></search>
			<add><![CDATA[<button id="button-sendcloud" title = "Orders doorsturen naar SendCloud" class="btn btn-info" form="form-order" formaction="<?php echo $sendcloud_url; ?>" form="form-order" type="submit" onclick="$('#form-order').attr('target', '_self');"  style="padding:4px 10px 3px 9px"><img src="../image/module/sendcloud/sendcloud.svg" style="width:111px; height:26px;"></button>]]></add>
		</operation>
		<operation error="abort">
			<search position="after"><![CDATA[$('#button-shipping, #button-invoice').prop('disabled', true);]]></search>
			<add><![CDATA[$('#button-sendcloud').addClass('disabled');]]></add>
		</operation>
		<operation error="abort">
			<search position="after"><![CDATA[$('#button-invoice').prop('disabled', false);]]></search>
			<add><![CDATA[$('#button-sendcloud').removeClass('disabled');]]></add>
		</operation>
		<operation error="abort">
			<search position="after"><![CDATA[$('input[name^=\'selected\']:first').trigger('change');]]></search>
			<add>
				<![CDATA[$('#form-order thead input[type=checkbox]').click(function() {
				if($(this).prop("checked")) {$('#button-sendcloud').removeClass('disabled');
				 } else {
				  $('#button-sendcloud').addClass('disabled');
				 }
				});]]>
			</add>
		</operation>
	</file>

	<file name="admin/controller/sale/order.php">
		<operation error="abort">
			<search position="after"><![CDATA[$data['invoice'] = $this->url->link('sale/order/invoice']]></search>
			<add><![CDATA[$data['sendcloud_url'] = \comercia\Util::url()->link('module/sendcloud/bulk', 'token=' . $this->session->data['token'], true);]]></add>
		</operation>
	</file>
</modification>
